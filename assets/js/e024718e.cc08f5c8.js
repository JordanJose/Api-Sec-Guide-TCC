"use strict";(self.webpackChunkapi_security_basic_guide=self.webpackChunkapi_security_basic_guide||[]).push([[4115],{3905:(e,a,r)=>{r.d(a,{Zo:()=>u,kt:()=>d});var n=r(7294);function t(e,a,r){return a in e?Object.defineProperty(e,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[a]=r,e}function s(e,a){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var a=1;a<arguments.length;a++){var r=null!=arguments[a]?arguments[a]:{};a%2?s(Object(r),!0).forEach((function(a){t(e,a,r[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(r,a))}))}return e}function i(e,a){if(null==e)return{};var r,n,t=function(e,a){if(null==e)return{};var r,n,t={},s=Object.keys(e);for(n=0;n<s.length;n++)r=s[n],a.indexOf(r)>=0||(t[r]=e[r]);return t}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)r=s[n],a.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var l=n.createContext({}),p=function(e){var a=n.useContext(l),r=a;return e&&(r="function"==typeof e?e(a):o(o({},a),e)),r},u=function(e){var a=p(e.components);return n.createElement(l.Provider,{value:a},e.children)},c={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},m=n.forwardRef((function(e,a){var r=e.components,t=e.mdxType,s=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),m=p(r),d=t,g=m["".concat(l,".").concat(d)]||m[d]||c[d]||s;return r?n.createElement(g,o(o({ref:a},u),{},{components:r})):n.createElement(g,o({ref:a},u))}));function d(e,a){var r=arguments,t=a&&a.mdxType;if("string"==typeof e||t){var s=r.length,o=new Array(s);o[0]=m;var i={};for(var l in a)hasOwnProperty.call(a,l)&&(i[l]=a[l]);i.originalType=e,i.mdxType="string"==typeof e?e:t,o[1]=i;for(var p=2;p<s;p++)o[p]=r[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},699:(e,a,r)=>{r.r(a),r.d(a,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var n=r(7462),t=(r(7294),r(3905));const s={sidebar_position:3},o="Corre\xe7\xe3o",i={unversionedId:"Vulnerabilidades/RegexDoS/correcao",id:"Vulnerabilidades/RegexDoS/correcao",title:"Corre\xe7\xe3o",description:"---",source:"@site/docs/Vulnerabilidades/8_RegexDoS/correcao.md",sourceDirName:"Vulnerabilidades/8_RegexDoS",slug:"/Vulnerabilidades/RegexDoS/correcao",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/RegexDoS/correcao",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"defaultSidebar",previous:{title:"Explora\xe7\xe3o",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/RegexDoS/exploracao"},next:{title:"Refer\xeancias",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/RegexDoS/referencias"}},l={},p=[{value:"Identificando trecho de c\xf3digo vulner\xe1vel",id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel",level:2},{value:"Mais refer\xeancias dispon\xedveis na OWASP.",id:"mais-refer\xeancias-dispon\xedveis-na-owasp",level:4}],u={toc:p};function c(e){let{components:a,...r}=e;return(0,t.kt)("wrapper",(0,n.Z)({},u,r,{components:a,mdxType:"MDXLayout"}),(0,t.kt)("h1",{id:"corre\xe7\xe3o"},"Corre\xe7\xe3o"),(0,t.kt)("hr",null),(0,t.kt)("p",null,"No geral, para corrigir esse tipo de vulnerabilidade \xe9 importante conhecer a aplica\xe7\xe3o e as entradas que s\xe3o tratadas por uma express\xe3o regular."),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Mapeie os campos de inser\xe7\xe3o de informa\xe7\xf5es em sua aplica\xe7\xe3o que utilizam regex.")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Use express\xf5es regulares bem recomendadas e testadas pela comunidade.")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Entenda como as regex da aplica\xe7\xe3o funcionam, evitando que haja a presen\xe7a de alguma ",(0,t.kt)("strong",{parentName:"p"},"Evil Regex"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Consulte o ",(0,t.kt)("a",{parentName:"p",href:"https://owasp.org/www-community/OWASP_Validation_Regex_Repository"},"material auxiliar da OWASP")," que cont\xe9m alguns exemplos de Regex.")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Consulte o ",(0,t.kt)("a",{parentName:"p",href:"https://github.com/engn33r/awesome-redos-security"},"ReDoS Security")," para conhecer alguns servi\xe7os e bibliotecas que possuem essa vulnerabilidade."))),(0,t.kt)("h2",{id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel"},"Identificando trecho de c\xf3digo vulner\xe1vel"),(0,t.kt)("p",null,"Para que uma corre\xe7\xe3o possa ser realizada, \xe9 necess\xe1rio encontrar o(s) trecho(s) de c\xf3digo da aplica\xe7\xe3o que utilizam essa ",(0,t.kt)("strong",{parentName:"p"},"Evil Regex"),"."),(0,t.kt)("p",null,"Ao analisar a rota ",(0,t.kt)("inlineCode",{parentName:"p"},"/users/v1/:username/email")," na documenta\xe7\xe3o da VAmPI (dispon\xedvel de acordo com o formato ",(0,t.kt)("a",{parentName:"p",href:"https://swagger.io/specification/"},"OpenAPI 3.0"),"), \xe9 poss\xedvel encontrar a fun\xe7\xe3o respons\xe1vel pela valida\xe7\xe3o do e-mail lendo o ",(0,t.kt)("inlineCode",{parentName:"p"},"operationId"),"."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-yml",metastring:'title="openapi3.yml - /users/v1/:username/email"',title:'"openapi3.yml',"-":!0,'/users/v1/:username/email"':!0},"...\noperationId: api_views.users.update_email\n...\n")),(0,t.kt)("p",null,"Agora, basta seguir o caminho entre os arquivos da VAmPI para encontrar a fun\xe7\xe3o vulner\xe1vel na aplica\xe7\xe3o."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="api_views/users.update_email"',title:'"api_views/users.update_email"'},'def update_email(username):\n    request_data = request.get_json()\n    try:\n        jsonschema.validate(request_data, update_email_schema)\n    except:\n        return Response(error_message_helper("Please provide a proper JSON body."), 400, mimetype="application/json")\n    resp = token_validator(request.headers.get(\'Authorization\'))\n    if "expired" in resp:\n        return Response(error_message_helper(resp), 401, mimetype="application/json")\n    elif "Invalid token" in resp:\n        return Response(error_message_helper(resp), 401, mimetype="application/json")\n    else:\n        user = User.query.filter_by(username=resp).first()\n        match = re.search(\n            r"^([a-zA-Z0-9])(([\\-.]|[_]+)?([a-zA-Z0-9]+))*(@){1}[a-z0-9]+[.]{1}(([a-z]{2,3})|([a-z]{2,3}[.]{1}[a-z]{2,3}))$",\n            str(request_data.get(\'email\')))\n        if match:\n            user.email = request_data.get(\'email\')\n            db.session.commit()\n            responseObject = {\n                \'status\': \'success\',\n                \'data\': {\n                    \'username\': user.username,\n                    \'email\': user.email\n                }\n            }\n            return Response(json.dumps(responseObject), 204, mimetype="application/json")\n        else:\n            return Response(error_message_helper("Please Provide a valid email address."), 400, mimetype="application/json")\n')),(0,t.kt)("p",null,"Para corrigir a vulnerabilidade, o mais importante \xe9 analisar a express\xe3o regular que est\xe1 sendo utilizada."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="Regex usado para validar e-mail"',title:'"Regex',usado:!0,para:!0,validar:!0,'e-mail"':!0},"^([a-zA-Z0-9])(([\\-.]|[_]+)?([a-zA-Z0-9]+))*(@){1}[a-z0-9]+[.]{1}(([a-z]{2,3})|([a-z]{2,3}[.]{1}[a-z]{2,3}))$\n")),(0,t.kt)("p",null,"Esse \xe9 o mesmo regex apresentado pela ",(0,t.kt)("a",{parentName:"p",href:"https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS"},"OWASP")," como um exemplo de ",(0,t.kt)("strong",{parentName:"p"},"Evil Regex")," para valida\xe7\xe3o de e-mail."),(0,t.kt)("p",null,"A pr\xf3pria ",(0,t.kt)("a",{parentName:"p",href:"https://www.oreilly.com/library/view/regular-expressions-cookbook/9781449327453/ch04s01.html"},"O`Reilly")," possui um reposit\xf3rio com algumas express\xf5es regulares para valida\xe7\xe3oo de e-mail."),(0,t.kt)("p",null,"A escolhida para essa corre\xe7\xe3o foi a ",(0,t.kt)("strong",{parentName:"p"},"^\\S+@\\S+$"),". Simples e funcional (lembrando que a express\xe3o regular pode variar conforme as regras de neg\xf3cio da sua aplica\xe7\xe3o)."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="Fun\xe7\xe3o com a nova express\xe3o regular"',title:'"Fun\xe7\xe3o',com:!0,a:!0,nova:!0,"express\xe3o":!0,'regular"':!0},"def update_email(username):\n    request_data = request.get_json()\n    try:\n        jsonschema.validate(request_data, update_email_schema)\n    except:\n        return Response(error_message_helper(\"Please provide a proper JSON body.\"), 400, mimetype=\"application/json\")\n    resp = token_validator(request.headers.get('Authorization'))\n    if \"expired\" in resp:\n        return Response(error_message_helper(resp), 401, mimetype=\"application/json\")\n    elif \"Invalid token\" in resp:\n        return Response(error_message_helper(resp), 401, mimetype=\"application/json\")\n    else:\n        user = User.query.filter_by(username=resp).first()\n        regex = '^\\S+@\\S+$'\n        if (re.search(regex, request_data.get('email'))):\n            user.email = request_data.get('email')\n            db.session.commit()\n            responseObject = {\n                'status': 'success',\n                'data': {\n                    'username': user.username,\n                    'email': user.email\n                }\n            }\n            return Response(json.dumps(responseObject), 204, mimetype=\"application/json\")\n        else:\n            return Response(error_message_helper(\"Please Provide a valid email address.\"), 400, mimetype=\"application/json\")\n")),(0,t.kt)("h4",{id:"mais-refer\xeancias-dispon\xedveis-na-owasp"},"Mais refer\xeancias dispon\xedveis na ",(0,t.kt)("a",{parentName:"h4",href:"https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS"},"OWASP"),"."))}c.isMDXComponent=!0}}]);