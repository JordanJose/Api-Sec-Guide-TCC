"use strict";(self.webpackChunkapi_security_basic_guide=self.webpackChunkapi_security_basic_guide||[]).push([[701],{3905:(e,a,r)=>{r.d(a,{Zo:()=>p,kt:()=>m});var n=r(7294);function o(e,a,r){return a in e?Object.defineProperty(e,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[a]=r,e}function t(e,a){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var a=1;a<arguments.length;a++){var r=null!=arguments[a]?arguments[a]:{};a%2?t(Object(r),!0).forEach((function(a){o(e,a,r[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(r,a))}))}return e}function i(e,a){if(null==e)return{};var r,n,o=function(e,a){if(null==e)return{};var r,n,o={},t=Object.keys(e);for(n=0;n<t.length;n++)r=t[n],a.indexOf(r)>=0||(o[r]=e[r]);return o}(e,a);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(n=0;n<t.length;n++)r=t[n],a.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var u=n.createContext({}),d=function(e){var a=n.useContext(u),r=a;return e&&(r="function"==typeof e?e(a):s(s({},a),e)),r},p=function(e){var a=d(e.components);return n.createElement(u.Provider,{value:a},e.children)},l={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},c=n.forwardRef((function(e,a){var r=e.components,o=e.mdxType,t=e.originalType,u=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=d(r),m=o,f=c["".concat(u,".").concat(m)]||c[m]||l[m]||t;return r?n.createElement(f,s(s({ref:a},p),{},{components:r})):n.createElement(f,s({ref:a},p))}));function m(e,a){var r=arguments,o=a&&a.mdxType;if("string"==typeof e||o){var t=r.length,s=new Array(t);s[0]=c;var i={};for(var u in a)hasOwnProperty.call(a,u)&&(i[u]=a[u]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var d=2;d<t;d++)s[d]=r[d];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}c.displayName="MDXCreateElement"},5975:(e,a,r)=>{r.r(a),r.d(a,{assets:()=>u,contentTitle:()=>s,default:()=>l,frontMatter:()=>t,metadata:()=>i,toc:()=>d});var n=r(7462),o=(r(7294),r(3905));const t={sidebar_position:3},s="Corre\xe7\xe3o",i={unversionedId:"Vulnerabilidades/Unauthorized Password Change/correcao",id:"Vulnerabilidades/Unauthorized Password Change/correcao",title:"Corre\xe7\xe3o",description:"No geral, n\xe3o h\xe1 muito segredo para corrigir esse tipo de vulnerabilidade:",source:"@site/docs/Vulnerabilidades/Unauthorized Password Change/correcao.md",sourceDirName:"Vulnerabilidades/Unauthorized Password Change",slug:"/Vulnerabilidades/Unauthorized Password Change/correcao",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/Unauthorized Password Change/correcao",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"defaultSidebar",previous:{title:"Explora\xe7\xe3o",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/Unauthorized Password Change/exploracao"},next:{title:"Refer\xeancias",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/Unauthorized Password Change/referencias"}},u={},d=[{value:"Identificando trecho de c\xf3digo vulner\xe1vel",id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel",level:2},{value:"Mais refer\xeancias dispon\xedveis na OWASP.",id:"mais-refer\xeancias-dispon\xedveis-na-owasp",level:4}],p={toc:d};function l(e){let{components:a,...r}=e;return(0,o.kt)("wrapper",(0,n.Z)({},p,r,{components:a,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"corre\xe7\xe3o"},"Corre\xe7\xe3o"),(0,o.kt)("p",null,"No geral, n\xe3o h\xe1 muito segredo para corrigir esse tipo de vulnerabilidade:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"\xc9 preciso garantir que os usu\xe1rios somente tenham acesso a funcionalidades \xe0 eles competidas. Por exemplo, apenas usu\xe1rios de administrador possam acessar fun\xe7\xf5es de administrador.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"As regras de neg\xf3cio devem ser seguidas e implementadas, definindo os perfis que acessar\xe3o endpoints e fun\xe7\xf5es da API.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Outra pr\xe1tica adicional \xe9 fazer com que a aplica\xe7\xe3o recuse qualquer tipo de acesso vindo de usu\xe1rios que n\xe3o estejam logados."))),(0,o.kt)("h2",{id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel"},"Identificando trecho de c\xf3digo vulner\xe1vel"),(0,o.kt)("p",null,"Para que uma corre\xe7\xe3o possa ser realizada, \xe9 necess\xe1rio encontrar o(s) trecho(s) de c\xf3digo da aplica\xe7\xe3o que utilizam esse m\xe9todo de autentica\xe7\xe3o falho."),(0,o.kt)("p",null,"Ao analisar a rota ",(0,o.kt)("inlineCode",{parentName:"p"},"/users/v1/{username}/password")," na documenta\xe7\xe3o da VAmPI (dispon\xedvel de acordo com o formato ",(0,o.kt)("a",{parentName:"p",href:"https://swagger.io/specification/"},"OpenAPI 3.0"),"), \xe9 poss\xedvel encontrar a fun\xe7\xe3o respons\xe1vel pela altera\xe7\xe3o da senha lendo o ",(0,o.kt)("inlineCode",{parentName:"p"},"operationId"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yml",metastring:'title="openapi3.yml - /users/v1/{username}/password"',title:'"openapi3.yml',"-":!0,'/users/v1/{username}/password"':!0},"...\noperationId: api_views.users.update_password\n...\n")),(0,o.kt)("p",null,"Agora, basta seguir o caminho entre os arquivos da VAmPI para encontrar a fun\xe7\xe3o vulner\xe1vel na aplica\xe7\xe3o."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="api_views/users.update_password"',title:'"api_views/users.update_password"'},'def update_password(username):\n    request_data = request.get_json()\n    resp = token_validator(request.headers.get(\'Authorization\'))\n    if "expired" in resp:\n        return Response(error_message_helper(resp), 401, mimetype="application/json")\n    elif "Invalid token" in resp:\n        return Response(error_message_helper(resp), 401, mimetype="application/json")\n    else:\n        if request_data.get(\'password\'):\n            user = User.query.filter_by(username=username).first()\n            if user:\n                user.password = request_data.get(\'password\')\n                db.session.commit()\n            else:\n                return Response(error_message_helper("User Not Found"), 400, mimetype="application/json")\n            responseObject = {\n                \'status\': \'success\',\n                \'Password\': \'Updated.\'\n            }\n            return Response(json.dumps(responseObject), 204, mimetype="application/json")\n        else:\n            return Response(error_message_helper("Malformed Data"), 400, mimetype="application/json")\n')),(0,o.kt)("p",null,"A suposi\xe7\xe3o feita no t\xf3pico anterior estava correta, a fun\xe7\xe3o utiliza o token JWT apenas como formar de garantir que um usu\xe1rio logado est\xe1 fazendo a requisi\xe7\xe3o. Mas, usa o nome de usu\xe1rio diretamente no m\xe9todo ",(0,o.kt)("inlineCode",{parentName:"p"},"query.filter_by()")," da classe ",(0,o.kt)("inlineCode",{parentName:"p"},"User"),", abrindo uma brecha de seguran\xe7a."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="Trecho de c\xf3digo vulner\xe1vel"',title:'"Trecho',de:!0,"c\xf3digo":!0,'vulner\xe1vel"':!0},"user = User.query.filter_by(username=username).first()\n")),(0,o.kt)("p",null,"Ent\xe3o, a solu\xe7\xe3o seria: Utilizar o token JWT como forma de autentica\xe7\xe3o do usu\xe1rio e excluindo o envio do nome de usu\xe1rio diretamente para o banco de dados."),(0,o.kt)("p",null,"Ao analisar o c\xf3digo da fun\xe7\xe3o, tamb\xe9m \xe9 poss\xedvel perceber que uma outra fun\xe7\xe3o \xe9 chamada, a ",(0,o.kt)("inlineCode",{parentName:"p"},"token_validator()"),", sendo usada para validar o token JWT."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"resp = token_validator(request.headers.get('Authorization'))\n")),(0,o.kt)("p",null,"Essa fun\xe7\xe3o pode ser a solu\xe7\xe3o do problema, tendo em vista que ela retorna o nome do usu\xe1rio ap\xf3s realizar a valida\xe7\xe3o do token."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'def token_validator(auth_header):\n    if auth_header:\n        try:\n            auth_token = auth_header.split(" ")[1]\n        except:\n            auth_token = ""\n    else:\n        auth_token = ""\n    if auth_token:\n        # Caso o token de autentica\xe7\xe3o seja v\xe1lido, a fun\xe7\xe3o retorna o nome de usu\xe1rio\n        return User.decode_auth_token(auth_token)\n    else:\n        return "Invalid token"\n')),(0,o.kt)("p",null,"Ent\xe3o, a corre\xe7\xe3o \xe9 relativamente simples, basta utilizar uma fun\xe7\xe3o que j\xe1 est\xe1 dispon\xedvel no c\xf3digo e que \xe9 subutilizada."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"def update_password(username):\n    request_data = request.get_json()\n    resp = token_validator(request.headers.get('Authorization'))\n    if \"expired\" in resp:\n        return Response(error_message_helper(resp), 401, mimetype=\"application/json\")\n    elif \"Invalid token\" in resp:\n        return Response(error_message_helper(resp), 401, mimetype=\"application/json\")\n    else:\n        if request_data.get('password'):\n            user = User.query.filter_by(username=resp).first() #corre\xe7\xe3o de vulnerabilidade\n            user.password = request_data.get('password')\n            db.session.commit()\n        responseObject = {\n            'status': 'success',\n            'Password': 'Updated.'\n        }\n        return Response(json.dumps(responseObject), 204, mimetype=\"application/json\")\n        else:\n            return Response(error_message_helper(\"Malformed Data\"), 400, mimetype=\"application/json\")\n")),(0,o.kt)("p",null,"A corre\xe7\xe3o foi realizada e a prova de identidade por meio exclusivo do nome de usu\xe1rio j\xe1 n\xe3o \xe9 mais utilizada, agora o JWT \xe9 o respons\xe1vel pela autenticidade do usu\xe1rio na hora da altera\xe7\xe3o da senha."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"user = User.query.filter_by(username=resp).first()\n")),(0,o.kt)("h4",{id:"mais-refer\xeancias-dispon\xedveis-na-owasp"},"Mais refer\xeancias dispon\xedveis na ",(0,o.kt)("a",{parentName:"h4",href:"https://github.com/OWASP/API-Security/blob/master/2019/en/src/0xa8-injection.md"},"OWASP"),"."))}l.isMDXComponent=!0}}]);