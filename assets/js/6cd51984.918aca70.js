"use strict";(self.webpackChunkapi_security_basic_guide=self.webpackChunkapi_security_basic_guide||[]).push([[297],{3905:(e,r,n)=>{n.d(r,{Zo:()=>d,kt:()=>m});var a=n(7294);function o(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function t(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);r&&(a=a.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?t(Object(n),!0).forEach((function(r){o(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}function i(e,r){if(null==e)return{};var n,a,o=function(e,r){if(null==e)return{};var n,a,o={},t=Object.keys(e);for(a=0;a<t.length;a++)n=t[a],r.indexOf(n)>=0||(o[n]=e[n]);return o}(e,r);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(a=0;a<t.length;a++)n=t[a],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),u=function(e){var r=a.useContext(l),n=r;return e&&(n="function"==typeof e?e(r):s(s({},r),e)),n},d=function(e){var r=u(e.components);return a.createElement(l.Provider,{value:r},e.children)},p={inlineCode:"code",wrapper:function(e){var r=e.children;return a.createElement(a.Fragment,{},r)}},c=a.forwardRef((function(e,r){var n=e.components,o=e.mdxType,t=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=u(n),m=o,f=c["".concat(l,".").concat(m)]||c[m]||p[m]||t;return n?a.createElement(f,s(s({ref:r},d),{},{components:n})):a.createElement(f,s({ref:r},d))}));function m(e,r){var n=arguments,o=r&&r.mdxType;if("string"==typeof e||o){var t=n.length,s=new Array(t);s[0]=c;var i={};for(var l in r)hasOwnProperty.call(r,l)&&(i[l]=r[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var u=2;u<t;u++)s[u]=n[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},6896:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>t,metadata:()=>i,toc:()=>u});var a=n(7462),o=(n(7294),n(3905));const t={sidebar_position:3},s="Corre\xe7\xe3o",i={unversionedId:"Vulnerabilidades/SQL Injection/correcao",id:"Vulnerabilidades/SQL Injection/correcao",title:"Corre\xe7\xe3o",description:"Vulnerabilidades envolvendo inje\xe7\xe3o maliciosa de strings SQL podem ser resolvidas seguindo alguns princ\xedpios b\xe1sicos, onde o principal \xe9 manter os dados separados dos comandos e das queries SQL.",source:"@site/docs/Vulnerabilidades/SQL Injection/correcao.md",sourceDirName:"Vulnerabilidades/SQL Injection",slug:"/Vulnerabilidades/SQL Injection/correcao",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/SQL Injection/correcao",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"defaultSidebar",previous:{title:"Explora\xe7\xe3o",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/SQL Injection/exploracao"},next:{title:"Refer\xeancias",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/SQL Injection/referencias"}},l={},u=[{value:"Identificando trecho de c\xf3digo vulner\xe1vel",id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel",level:2},{value:"Mais refer\xeancias dispon\xedveis na OWASP.",id:"mais-refer\xeancias-dispon\xedveis-na-owasp",level:4}],d={toc:u};function p(e){let{components:r,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:r,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"corre\xe7\xe3o"},"Corre\xe7\xe3o"),(0,o.kt)("p",null,"Vulnerabilidades envolvendo inje\xe7\xe3o maliciosa de strings SQL podem ser resolvidas seguindo alguns princ\xedpios b\xe1sicos, onde o principal \xe9 manter os dados separados dos comandos e das queries SQL."),(0,o.kt)("h2",{id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel"},"Identificando trecho de c\xf3digo vulner\xe1vel"),(0,o.kt)("p",null,"Para que uma corre\xe7\xe3o possa ser realizada, \xe9 necess\xe1rio encontrar o(s) trecho(s) de c\xf3digo da aplica\xe7\xe3o que possam estar utilizando queries SQL sem qualquer tipo de sanitiza\xe7\xe3o ou tratamento especial."),(0,o.kt)("p",null,"Ao analisar a rota ",(0,o.kt)("inlineCode",{parentName:"p"},"/users/v1/{username}")," na documenta\xe7\xe3o da VAmPI (dispon\xedvel de acordo com o formato ",(0,o.kt)("a",{parentName:"p",href:"https://swagger.io/specification/"},"OpenAPI 3.0"),"), \xe9 poss\xedvel encontrar a fun\xe7\xe3o respons\xe1vel pelos dados lendo o ",(0,o.kt)("inlineCode",{parentName:"p"},"operationId"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yml",metastring:'title="openapi3.yml - /users/v1/{username}"',title:'"openapi3.yml',"-":!0,'/users/v1/{username}"':!0},"...\noperationId: api_views.users.get_by_username\n...\n")),(0,o.kt)("p",null,"Agora, basta seguir o caminho entre os arquivos da VAmPI para encontrar a fun\xe7\xe3o vulner\xe1vel na aplica\xe7\xe3o."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="api_views/users.get_by_username"',title:'"api_views/users.get_by_username"'},'def get_by_username(username):\n    if User.get_user(username):\n        return Response(str(User.get_user(username)), 200, mimetype="application/json")\n    else:\n        return Response(error_message_helper("User not found"), 404, mimetype="application/json")\n')),(0,o.kt)("p",null,"A fun\xe7\xe3o usa o m\xe9todo ",(0,o.kt)("inlineCode",{parentName:"p"},"get_user()")," da classe ",(0,o.kt)("inlineCode",{parentName:"p"},"User")," para retornar as informa\xe7\xf5es do usu\xe1rio, classe essa que \xe9 importada do ",(0,o.kt)("inlineCode",{parentName:"p"},"models/user_model"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"from models.user_model import User\n")),(0,o.kt)("p",null,"Logo, a vulnerabilidade est\xe1 na forma como o m\xe9todo ",(0,o.kt)("inlineCode",{parentName:"p"},"User.get_user")," trata o username dos usu\xe1rios, ent\xe3o \xe9 necess\xe1rio fazer uma revis\xe3o de c\xf3digo a fim de encontrar o ponto de falha e realizar as corre\xe7\xf5es."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'def get_user(username):\n    user_query = f"SELECT * FROM users WHERE username = \'{username}\'"\n    query = db.session.execute(user_query)\n    ret = query.fetchone()\n    if ret:\n        fin_query = \'{"username": "%s", "email": "%s"}\' % (ret[1], ret[3])\n    else:\n        fin_query = None\n    return fin_query\n')),(0,o.kt)("p",null,"A vulnerabilidade est\xe1 justamente na forma como o username \xe9 usado para compor a query SQL, n\xe3o h\xe1 nenhum tipo de tratamento ou sanitiza\xe7\xe3o da entrada no trecho ",(0,o.kt)("inlineCode",{parentName:"p"},"f\"SELECT * FROM users WHERE username = '{username}'\""),"."),(0,o.kt)("p",null,"Dessa forma, h\xe1 duas alternativas que podem ser interessantes para a corre\xe7\xe3o dessa vulnerabilidade:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Sanitiza\xe7\xe3o da string username, evitando que caracteres maliciosos sejam usados;"),(0,o.kt)("li",{parentName:"ul"},"Uso do m\xe9todo nativo do SQLAlchemy para consulta no banco de dados.")),(0,o.kt)("p",null,"A solu\xe7\xe3o mais r\xe1pida e confi\xe1vel \xe9 o uso do m\xe9todo ",(0,o.kt)("inlineCode",{parentName:"p"},"query.filter_by()")," do pr\xf3prio SQLAlchemy, dispon\xedvel na ",(0,o.kt)("a",{parentName:"p",href:"https://flask-sqlalchemy.palletsprojects.com/en/2.x/quickstart/#quickstart"},"documenta\xe7\xe3o da biblioteca"),"."),(0,o.kt)("p",null,"Ap\xf3s a corre\xe7\xe3o, o trecho de c\xf3digo abaixo ser\xe1 o ",(0,o.kt)("inlineCode",{parentName:"p"},"get_user()"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"def get_user(username):\n    fin_query = User.query.filter_by(username=username).first()\n    return fin_query\n")),(0,o.kt)("p",null,"Al\xe9m da melhoria de seguran\xe7a, usando a fun\xe7\xe3o dispon\xedvel na pr\xf3pria biblioteca do SQLAlchemy o m\xe9todo se tornou muito menor e mais leg\xedvel."),(0,o.kt)("h4",{id:"mais-refer\xeancias-dispon\xedveis-na-owasp"},"Mais refer\xeancias dispon\xedveis na ",(0,o.kt)("a",{parentName:"h4",href:"https://github.com/OWASP/API-Security/blob/master/2019/en/src/0xa8-injection.md"},"OWASP"),"."))}p.isMDXComponent=!0}}]);