"use strict";(self.webpackChunkapi_security_basic_guide=self.webpackChunkapi_security_basic_guide||[]).push([[3309],{3905:(e,a,r)=>{r.d(a,{Zo:()=>l,kt:()=>m});var s=r(7294);function n(e,a,r){return a in e?Object.defineProperty(e,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[a]=r,e}function t(e,a){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);a&&(s=s.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),r.push.apply(r,s)}return r}function i(e){for(var a=1;a<arguments.length;a++){var r=null!=arguments[a]?arguments[a]:{};a%2?t(Object(r),!0).forEach((function(a){n(e,a,r[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(r,a))}))}return e}function o(e,a){if(null==e)return{};var r,s,n=function(e,a){if(null==e)return{};var r,s,n={},t=Object.keys(e);for(s=0;s<t.length;s++)r=t[s],a.indexOf(r)>=0||(n[r]=e[r]);return n}(e,a);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(s=0;s<t.length;s++)r=t[s],a.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var u=s.createContext({}),d=function(e){var a=s.useContext(u),r=a;return e&&(r="function"==typeof e?e(a):i(i({},a),e)),r},l=function(e){var a=d(e.components);return s.createElement(u.Provider,{value:a},e.children)},p={inlineCode:"code",wrapper:function(e){var a=e.children;return s.createElement(s.Fragment,{},a)}},c=s.forwardRef((function(e,a){var r=e.components,n=e.mdxType,t=e.originalType,u=e.parentName,l=o(e,["components","mdxType","originalType","parentName"]),c=d(r),m=n,g=c["".concat(u,".").concat(m)]||c[m]||p[m]||t;return r?s.createElement(g,i(i({ref:a},l),{},{components:r})):s.createElement(g,i({ref:a},l))}));function m(e,a){var r=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var t=r.length,i=new Array(t);i[0]=c;var o={};for(var u in a)hasOwnProperty.call(a,u)&&(o[u]=a[u]);o.originalType=e,o.mdxType="string"==typeof e?e:n,i[1]=o;for(var d=2;d<t;d++)i[d]=r[d];return s.createElement.apply(null,i)}return s.createElement.apply(null,r)}c.displayName="MDXCreateElement"},6176:(e,a,r)=>{r.r(a),r.d(a,{assets:()=>u,contentTitle:()=>i,default:()=>p,frontMatter:()=>t,metadata:()=>o,toc:()=>d});var s=r(7462),n=(r(7294),r(3905));const t={sidebar_position:3},i="Corre\xe7\xe3o",o={unversionedId:"Vulnerabilidades/Mass_Assignment/correcao",id:"Vulnerabilidades/Mass_Assignment/correcao",title:"Corre\xe7\xe3o",description:"---",source:"@site/docs/Vulnerabilidades/4_Mass_Assignment/correcao.md",sourceDirName:"Vulnerabilidades/4_Mass_Assignment",slug:"/Vulnerabilidades/Mass_Assignment/correcao",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/Mass_Assignment/correcao",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"defaultSidebar",previous:{title:"Explora\xe7\xe3o",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/Mass_Assignment/exploracao"},next:{title:"Refer\xeancias",permalink:"/Api-Sec-Guide-TCC/docs/Vulnerabilidades/Mass_Assignment/referencias"}},u={},d=[{value:"Identificando trecho de c\xf3digo vulner\xe1vel",id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel",level:2},{value:"Mais refer\xeancias dispon\xedveis na OWASP.",id:"mais-refer\xeancias-dispon\xedveis-na-owasp",level:4}],l={toc:d};function p(e){let{components:a,...r}=e;return(0,n.kt)("wrapper",(0,s.Z)({},l,r,{components:a,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"corre\xe7\xe3o"},"Corre\xe7\xe3o"),(0,n.kt)("hr",null),(0,n.kt)("p",null,"A corre\xe7\xe3o para esse tipo de vulnerabilidade varia muito de acordo com as regras de neg\xf3cio da aplica\xe7\xe3o, \xe9 necess\xe1rio entend\xea-las para poder definir todas as tratativas e excess\xf5es de um objeto."),(0,n.kt)("p",null,"Mas, no geral \xe9 preciso ter aten\xe7\xe3o \xe0 alguns t\xf3picos:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Evite usar fun\xe7\xf5es que usem uma entrada do usu\xe1rio diretamente em uma vari\xe1vel ou em um objeto.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Fa\xe7a um levantamento das propriedades que podem ser acessadas por um usu\xe1rio, isolando as propriedades que s\xe3o proibidas.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Crie e valide schemas para as entradas das requisi\xe7\xf5es.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Tenha aten\xe7\xe3o aos par\xe2metros que n\xe3o possuem valida\xe7\xe3o, principalmente se forem previs\xedveis."))),(0,n.kt)("h2",{id:"identificando-trecho-de-c\xf3digo-vulner\xe1vel"},"Identificando trecho de c\xf3digo vulner\xe1vel"),(0,n.kt)("p",null,"Para que uma corre\xe7\xe3o possa ser realizada, \xe9 necess\xe1rio encontrar o(s) trecho(s) de c\xf3digo da aplica\xe7\xe3o que utilizam esse m\xe9todo de autentica\xe7\xe3o falho."),(0,n.kt)("p",null,"Ao analisar a rota ",(0,n.kt)("inlineCode",{parentName:"p"},"/users/v1/register")," na documenta\xe7\xe3o da VAmPI (dispon\xedvel de acordo com o formato ",(0,n.kt)("a",{parentName:"p",href:"https://swagger.io/specification/"},"OpenAPI 3.0"),"), \xe9 poss\xedvel encontrar a fun\xe7\xe3o respons\xe1vel pela altera\xe7\xe3o da senha lendo o ",(0,n.kt)("inlineCode",{parentName:"p"},"operationId"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yml",metastring:'title="openapi3.yml - /users/v1/register"',title:'"openapi3.yml',"-":!0,'/users/v1/register"':!0},"...\noperationId: api_views.users.register_user\n...\n")),(0,n.kt)("p",null,"Agora, basta seguir o caminho entre os arquivos da VAmPI para encontrar a fun\xe7\xe3o vulner\xe1vel na aplica\xe7\xe3o."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="api_views/users.register_user"',title:'"api_views/users.register_user"'},"def register_user():\n    request_data = request.get_json()\n    # check if user already exists\n    user = User.query.filter_by(username=request_data.get('username')).first()\n    if not user:\n        try:\n            # validate the data are in the correct form\n            jsonschema.validate(request_data, register_user_schema)\n            if 'admin' in request_data:\n                if request_data['admin']:\n                    admin = True\n                else:\n                    admin = False\n                user = User(username=request_data['username'], password=request_data['password'],\n                            email=request_data['email'], admin=admin)\n            else:\n                user = User(username=request_data['username'], password=request_data['password'],\n                            email=request_data['email'])\n            db.session.add(user)\n            db.session.commit()\n\n            responseObject = {\n                'status': 'success',\n                'message': 'Successfully registered. Login to receive an auth token.'\n            }\n\n            return Response(json.dumps(responseObject), 200, mimetype=\"application/json\")\n        except jsonschema.exceptions.ValidationError as exc:\n            return Response(error_message_helper(exc.message), 400, mimetype=\"application/json\")\n    else:\n        return Response(error_message_helper(\"User already exists. Please Log in.\"), 200, mimetype=\"application/json\")\n")),(0,n.kt)("p",null,"Analisando o trecho da fun\xe7\xe3o abaixo fica mais f\xe1cil perceber o motivo da vulnerabilidade existir:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="Trecho de c\xf3digo vulner\xe1vel"',title:'"Trecho',de:!0,"c\xf3digo":!0,'vulner\xe1vel"':!0},"if 'admin' in request_data:\n    if request_data['admin']:\n        admin = True\n    else:\n        admin = False\n    user = User(username=request_data['username'], password=request_data['password'],\n                email=request_data['email'], admin=admin)\n")),(0,n.kt)("p",null,"Pela l\xf3gica implementada, basta o usu\xe1rio fornecer o par\xe2metro ",(0,n.kt)("strong",{parentName:"p"},"admin")," no body da requisi\xe7\xe3o com um valor booleano ",(0,n.kt)("inlineCode",{parentName:"p"},"true"),", assim ele ter\xe1 a permiss\xe3o de administrador."),(0,n.kt)("p",null,"Dessa forma a melhor solu\xe7\xe3o \xe9 simples: Basta que esse tipo de valida\xe7\xe3o n\xe3o exista no c\xf3digo."),(0,n.kt)("p",null,"A fun\xe7\xe3o de registro de usu\xe1rios n\xe3o deve decidir quem pode ou n\xe3o ser administrador, fica a cargo de outras fun\xe7\xf5es que podem ser implementadas especificamente para isso, com os devidos requisitos de seguran\xe7a e respeitando as regras de neg\xf3cio."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="Fun\xe7\xe3o register_user corrigida"',title:'"Fun\xe7\xe3o',register_user:!0,'corrigida"':!0},"def register_user():\n    request_data = request.get_json()\n    # check if user already exists\n    user = User.query.filter_by(username=request_data.get('username')).first()\n    if not user:\n        try:\n            # validate the data are in the correct form\n            jsonschema.validate(request_data, register_user_schema)\n            user = User(username=request_data['username'], password=request_data['password'],\n                        email=request_data['email'])\n            db.session.add(user)\n            db.session.commit()\n\n            responseObject = {\n                'status': 'success',\n                'message': 'Successfully registered. Login to receive an auth token.'\n            }\n\n            return Response(json.dumps(responseObject), 200, mimetype=\"application/json\")\n        except jsonschema.exceptions.ValidationError as exc:\n            return Response(error_message_helper(exc.message), 400, mimetype=\"application/json\")\n    else:\n        return Response(error_message_helper(\"User already exists. Please Log in.\"), 200, mimetype=\"application/json\")\n")),(0,n.kt)("p",null,"Pronto, agora a fun\xe7\xe3o usada para registrar um novo usu\xe1rio possui apenas esta funcionalidade, removendo a op\xe7\xe3o de atribuir o cargo de admin."),(0,n.kt)("p",null,"Essa separa\xe7\xe3o \xe9 muito importante, tendo em vista que as regras para a cria\xe7\xe3o de um novo usu\xe1rio e para a cria\xe7\xe3o de um administrador s\xe3o muito distintas, possuindo muitos processos de seguran\xe7a atrelados."),(0,n.kt)("h4",{id:"mais-refer\xeancias-dispon\xedveis-na-owasp"},"Mais refer\xeancias dispon\xedveis na ",(0,n.kt)("a",{parentName:"h4",href:"https://github.com/OWASP/API-Security/blob/master/2019/en/src/0xa6-mass-assignment.md"},"OWASP"),"."))}p.isMDXComponent=!0}}]);